name: Deploy Docs

# Deploys the docs app to Vercel production when a docs-vX.X.X tag is pushed
# This workflow is triggered by tags matching the pattern docs-v*.*.*

permissions:
    actions: write
    contents: read
    deployments: write

env:
    VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    VERCEL_DOCS_PROJECT_ID: ${{ secrets.VERCEL_DOCS_PROJECT_ID }}
    VERCEL_STORYBOOK_PROJECT_ID: ${{ secrets.VERCEL_STORYBOOK_PROJECT_ID }}

on:
    push:
        tags:
            - 'docs-v*.*.*'

concurrency:
    group: deploy-docs-${{ github.ref }}
    cancel-in-progress: false

jobs:
    parse-docs-tag:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.extract-version.outputs.version }}
        steps:
            - name: Extract version from tag
              id: extract-version
              run: |
                  # Extract version from docs-vX.X.X format (e.g., docs-v1.2.3 -> 1.2.3)
                  TAG="${GITHUB_REF#refs/tags/}"
                  VERSION="${TAG#docs-v}"
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Deploying docs version: $VERSION"

    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  # Minimal checkout just to make the action file available
                  fetch-depth: 1

            - name: Build
              uses: ./.github/actions/build
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: '0'

    lint:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  # Minimal checkout just to make the action file available
                  fetch-depth: 1

            - name: Lint
              uses: ./.github/actions/lint
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: '0'

    test:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  # Minimal checkout just to make the action file available
                  fetch-depth: 1

            - name: Test
              uses: ./.github/actions/test
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: '0'

    deploy-docs:
        runs-on: ubuntu-latest
        needs: [parse-docs-tag, build, lint, test]
        environment:
            name: docs-production
            url: ${{ steps.deploy-docs.outputs.deployment-url }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Prepare Environment
              uses: ./.github/actions/setup-env
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Deploy Docs to Vercel
              id: deploy-docs
              uses: ./.github/actions/deploy-vercel
              timeout-minutes: 20
              with:
                  vercel-token: ${{ secrets.VERCEL_ACCESS_TOKEN }}
                  vercel-org-id: ${{ env.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ env.VERCEL_DOCS_PROJECT_ID }}
                  environment: production
                  build-args: '--prod'
                  deploy-args: '--prod'

    deploy-storybook:
        runs-on: ubuntu-latest
        needs: [parse-docs-tag, build, lint, test]
        environment:
            name: storybook-production
            url: ${{ steps.deploy-storybook.outputs.deployment-url }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Prepare Environment
              uses: ./.github/actions/setup-env
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Deploy Storybook to Vercel
              id: deploy-storybook
              uses: ./.github/actions/deploy-vercel
              timeout-minutes: 20
              with:
                  vercel-token: ${{ secrets.VERCEL_ACCESS_TOKEN }}
                  vercel-org-id: ${{ env.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ env.VERCEL_STORYBOOK_PROJECT_ID }}
                  environment: production
                  build-args: '--prod'
                  deploy-args: '--prod'
