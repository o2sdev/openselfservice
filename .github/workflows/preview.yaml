name: Deploy Docs Preview

# Deploys preview environments for the docs app on pull requests
# This workflow runs on PR events and deploys to Vercel preview environment

permissions:
    actions: write
    contents: read
    checks: read
    pull-requests: write
    deployments: write

env:
    VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

on:
    pull_request:
        types: [opened, synchronize]

concurrency:
    group: deploy-docs-preview-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    skip-duplicate-check:
        runs-on: ubuntu-latest
        outputs:
            should_skip: ${{ steps.skip_check.outputs.should_skip }}
        steps:
            - id: skip_check
              uses: fkirc/skip-duplicate-actions@v5
              with:
                  concurrent_skipping: 'outdated_runs'
                  cancel_others: 'true'

    changed-packages:
        needs: skip-duplicate-check
        if: needs.skip-duplicate-check.outputs.should_skip != 'true'
        runs-on: ubuntu-latest
        outputs:
            package_changed: ${{ steps.determine-changes.outputs.package_changed }}
        steps:
            - name: Determine which packages changed
              id: determine-changes
              uses: ./.github/actions/changed-packages
              with:
                  event-name: ${{ github.event_name }}
                  base-sha: ${{ github.event.pull_request.base.sha }}
                  fetch-depth: '0'

    deploy-docs-preview:
        runs-on: ubuntu-latest
        needs: [skip-duplicate-check, changed-packages]
        if: |
            needs.skip-duplicate-check.outputs.should_skip != 'true' &&
            contains(toJson(fromJson(needs.changed-packages.outputs.package_changed).packages), 'docs')
        steps:
            - name: Deploy Docs Preview to Vercel
              uses: ./.github/actions/deploy-docs
              timeout-minutes: 20
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  vercel-token: ${{ secrets.VERCEL_ACCESS_TOKEN }}
                  vercel-project-id: ${{ secrets.VERCEL_DOCS_PROJECT_ID }}
                  environment: preview
                  fetch-depth: '0'
                  run-quality-checks: 'true'
                  build-args: ''
                  deploy-args: ''
