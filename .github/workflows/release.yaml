name: Release

# Publishes npm packages to the registry using Changesets
# This workflow runs on pushes to the main branch and handles versioning and publishing

permissions:
    contents: write
    packages: write
    pull-requests: write

env:
    TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
    TURBO_TEAM: ${{ vars.TURBO_TEAM }}

on:
    push:
        branches:
            - main

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: true

jobs:
    skip-duplicate-check:
        runs-on: ubuntu-latest
        outputs:
            should_skip: ${{ steps.skip_check.outputs.should_skip }}
        steps:
            - id: skip_check
              uses: fkirc/skip-duplicate-actions@v5
              with:
                  concurrent_skipping: 'outdated_runs'
                  cancel_others: 'true'

    build:
        needs: skip-duplicate-check
        if: needs.skip-duplicate-check.outputs.should_skip != 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  # Minimal checkout just to make the action file available
                  fetch-depth: 1

            - name: Build
              uses: ./.github/actions/build
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: '0'

    lint:
        needs: [skip-duplicate-check, build]
        if: needs.skip-duplicate-check.outputs.should_skip != 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  # Minimal checkout just to make the action file available
                  fetch-depth: 1

            - name: Lint
              uses: ./.github/actions/lint
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: '0'

    test:
        needs: [skip-duplicate-check, build]
        if: needs.skip-duplicate-check.outputs.should_skip != 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  # Minimal checkout just to make the action file available
                  fetch-depth: 1

            - name: Test
              uses: ./.github/actions/test
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: '0'

    publish-packages:
        runs-on: ubuntu-latest
        needs: [skip-duplicate-check, build, lint, test]
        if: needs.skip-duplicate-check.outputs.should_skip != 'true'
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Prepare Environment
              uses: ./.github/actions/setup-env
              timeout-minutes: 10
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure npm registry
              run: |
                  cat << EOF > "$HOME/.npmrc"
                  @o2s:registry=https://registry.npmjs.org
                  //registry.npmjs.org/:_authToken=$NPM_TOKEN
                  EOF
              env:
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Create Release Pull Request or Publish to npm
              id: changesets
              uses: changesets/action@v1
              with:
                  publish: npm run release
                  commit: 'feat(changeset): version packages'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
