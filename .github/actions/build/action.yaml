name: Build

description: 'Checkout code, setup environment, build project, and cache build outputs'

inputs:
    repo-token:
        description: 'Token to access the repository'
        required: true
    fetch-depth:
        description: 'Git fetch depth for checkout'
        required: false
        default: '0'

runs:
    using: 'composite'
    steps:
        - name: Checkout code
          uses: actions/checkout@v6
          with:
              fetch-depth: ${{ inputs.fetch-depth }}

        - name: Prepare Environment
          uses: ./.github/actions/setup-env
          with:
              repo-token: ${{ inputs.repo-token }}

        - name: Restore build outputs from cache
          id: cache-build
          uses: actions/cache/restore@v4
          with:
              path: |
                  **/.turbo/**
                  **/dist/**
                  **/build/**
                  **/.next/**
                  **/generated/**
                  !**/node_modules/**
              key: ${{ runner.os }}-build-${{ github.sha }}-${{ hashFiles('**/package-lock.json', '**/tsconfig.json', '**/turbo.json') }}
              restore-keys: |
                  ${{ runner.os }}-build-${{ github.sha }}-
                  ${{ runner.os }}-build-

        - name: Build
          shell: bash
          run: |
              set -e
              # Build will be faster if cache hit (Turborepo handles its own caching)
              npm run build

        - name: Save build outputs to cache
          uses: actions/cache/save@v4
          if: always()
          with:
              path: |
                  **/.turbo/**
                  **/dist/**
                  **/build/**
                  **/.next/**
                  !**/node_modules/**
              key: ${{ runner.os }}-build-${{ github.sha }}-${{ hashFiles('**/package-lock.json', '**/tsconfig.json', '**/turbo.json') }}
