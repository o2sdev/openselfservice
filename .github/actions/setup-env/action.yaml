name: Prepare environment

description: 'Sets up Node.js environment and installs dependencies with caching'

inputs:
    repo-token:
        description: 'Token to access the repo'
        required: true

runs:
    using: 'composite'
    steps:
        - uses: actions/setup-node@v6
          with:
              node-version: 24
              cache: 'npm'

        - name: Restore node_modules from cache
          id: cache-node-modules
          uses: actions/cache/restore@v4
          with:
              path: |
                  node_modules
                  **/node_modules
                  **/generated/**
              key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
              restore-keys: |
                  ${{ runner.os }}-node-modules-

        - name: Install Packages
          if: steps.cache-node-modules.outputs.cache-hit != 'true'
          shell: bash
          run: |
              set -e
              npm ci
          env:
              CI: true

        - name: Save node_modules to cache
          if: steps.cache-node-modules.outputs.cache-hit != 'true'
          uses: actions/cache/save@v4
          with:
              path: |
                  node_modules
                  **/node_modules
                  **/generated/**
              key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
