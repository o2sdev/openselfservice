name: Test

description: 'Checkout code, setup environment, install Playwright browsers, restore build outputs from cache, and run tests'

inputs:
    repo-token:
        description: 'Token to access the repository'
        required: true
    fetch-depth:
        description: 'Git fetch depth for checkout'
        required: false
        default: '0'

runs:
    using: 'composite'
    steps:
        - name: Checkout code
          uses: actions/checkout@v6
          with:
              fetch-depth: ${{ inputs.fetch-depth }}

        - name: Prepare Environment
          uses: ./.github/actions/setup-env
          with:
              repo-token: ${{ inputs.repo-token }}

        - name: Restore build outputs from cache
          uses: actions/cache/restore@v4
          with:
              path: |
                  **/dist/**
                  **/build/**
                  **/.next/**
                  **/next-env.d.ts
                  !**/node_modules/**
              key: ${{ runner.os }}-build-${{ github.sha }}

        - name: Install Playwright Browsers
          shell: bash
          run: npx playwright install --with-deps
          env:
              CI: true

        - name: Test
          shell: bash
          run: npm run test

        - name: Collect coverage
          shell: bash
          run: npx turbo run collect-json-reports --filter=@o2s/vitest-config

        - name: Check for coverage
          id: check-coverage
          shell: bash
          run: |
              if ls packages/configs/vitest-config/coverage/raw/*.json 1>/dev/null 2>&1; then
                echo "has_coverage=true" >> $GITHUB_OUTPUT
              else
                echo "has_coverage=false" >> $GITHUB_OUTPUT
              fi

        - name: Merge coverage and generate report
          if: steps.check-coverage.outputs.has_coverage == 'true'
          shell: bash
          run: npx turbo run merge-json-reports merge-summary-reports report --filter=@o2s/vitest-config

        - name: Upload coverage report
          if: steps.check-coverage.outputs.has_coverage == 'true'
          uses: actions/upload-artifact@v4
          with:
              name: coverage-report
              path: packages/configs/vitest-config/coverage/report
              retention-days: 14

        - name: Vitest coverage report
          if: steps.check-coverage.outputs.has_coverage == 'true'
          uses: davelosert/vitest-coverage-report-action@v2
          with:
              working-directory: packages/configs/vitest-config
              vite-config-path: api.js
              json-summary-path: coverage/coverage-summary.json
              json-final-path: coverage/merged/merged-coverage.json
              github-token: ${{ inputs.repo-token }}
